<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper 
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="org.gmod.cat.Regions">  

  
  <select id="locationsMinAndMaxBoundaries" resultType="org.genedb.crawl.model.LocationBoundaries">
    SELECT 
	    
	    min(fmin) as start, 
	    max(fmax) as end 
	    
	FROM feature f
	
	JOIN featureloc fl ON (f.feature_id = fl.feature_id AND fl.srcfeature_id = #{regionid} )
	
	WHERE f.type_id in 
	    <foreach item="item" index="index" collection="types" open="(" separator="," close=")"> 
            #{item} 
        </foreach> 
	
	<![CDATA[
		AND (
		    (fl.fmin BETWEEN #{start} AND #{end} ) 
		    OR (fl.fmax BETWEEN #{start} AND #{end} ) 
		    OR ( fl.fmin <= #{start} AND fl.fmax >= #{end} ) 
		)
    ]]>
  </select>
  
  <select id="locations" resultType="org.genedb.crawl.model.LocationRegion" >
    
    SELECT
    f.uniqueName as feature, 
    type.name as type, 
    fl.fmin as start, 
    fl.fmax as end,
    fl.strand as strand,
    fl.phase as phase,
    f.is_obsolete,
    f2.uniquename as part_of,
    fl.is_fmin_partial as fmin_partial,
    fl.is_fmax_partial as fmax_partial

	FROM feature f
	
	JOIN cvterm type ON f.type_id = type.cvterm_id 
	JOIN featureloc fl ON (f.feature_id = fl.feature_id AND fl.srcfeature_id = #{regionid} )
	
	LEFT OUTER JOIN feature_relationship fr ON f.feature_id = fr.subject_id AND fr.type_id = (select cvterm_id from cvterm where name = 'part_of')
	LEFT OUTER JOIN feature f2 ON fr.object_id = f2.feature_id
	
	WHERE 
	<![CDATA[
		
		(
		    (fl.fmin BETWEEN #{start} AND #{end} ) 
		    OR (fl.fmax BETWEEN #{start} AND #{end} ) 
		    OR ( fl.fmin <= #{start} AND fl.fmax >= #{end} ) 
		)
		
	]]>
	
	<if test="exclude != null"> 
        AND type.name NOT IN 
        <foreach item="item" index="index" collection="exclude" open="(" separator="," close=")"> 
            #{item} 
        </foreach> 
    </if> 
	    
	ORDER BY fl.fmin, fl.fmax
	
   
  </select>
  

</mapper> 
