<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper 
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="org.gmod.cat.OrganismsMapper">  
    
    <sql id="select_organism">
        select 
	       o.genus, o.species, o.common_name, o.organism_id as ID, op.value as taxonID 
	    from 
	       organism o
	     left outer join organismprop op on op.organism_id = o.organism_id and op.type_id = 
	       (select cvterm.cvterm_id from cvterm where name = 'taxonId')
    </sql>
    
  <select id="list" resultType="org.genedb.crawl.model.Organism" >
  	 <include refid="select_organism"/>
  	 
  	 WHERE o.common_name != 'dummy'
  	 
  	 order by o.genus, o.species
  	 
  </select>
  
  <select id="getByID" resultType="org.genedb.crawl.model.Organism" >
    <include refid="select_organism"/>
        WHERE o.organism_id = #{ID}
  </select>
  
  <select id="getByTaxonID" resultType="org.genedb.crawl.model.Organism" >
    <include refid="select_organism"/> 
        WHERE op.value = #{taxonID}
  </select>
  
  <select id="getByCommonName" resultType="org.genedb.crawl.model.Organism" >
        <include refid="select_organism"/> 
        WHERE o.common_name = #{commonName}
  </select>
  
  <select id="getOrganismProp" resultType="org.genedb.crawl.model.OrganismProp" >
    SELECT op.value as value 
        FROM organismprop op
        JOIN organism o ON op.organism_id = o.organism_id
        JOIN cvterm ON op.type_id = cvterm_id
        JOIN cv ON cvterm.cv_id = cv.cv_id
        WHERE op.organism_id = #{ID}
        
        <if test="cvterm != null" >
            AND cvterm.name = #{cvterm}
        </if>
        
        <if test="cv != null" >
            AND cv.name = #{cv}
        </if>
  </select>
    
   
</mapper> 
